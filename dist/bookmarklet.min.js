javascript:/*! * Smart Editor Pro v3.1 (CSP Bypass Edition) * Autor: Ernesto Barrera * Updated: 2025-01-11 */(function () % 7B  'use strict';  /* 1. Capturar contenido de la p√°gina actual antes de salir */  function getSelectedContent() % 7B    try % 7B      var selection = window.getSelection(); if (!selection % 7C % 7C selection.rangeCount === 0 % 7C % 7C selection.isCollapsed) % 7B        return '';      % 7D      var container = document.createElement('div'); for (var i = 0; i < selection.rangeCount; i++) % 7B        container.appendChild(selection.getRangeAt(i).cloneContents());      % 7D      return container.innerHTML;    % 7D catch (e) % 7B      console.warn('Error capturando selecci√≥n:', e); return '';    % 7D % 7D  const initialContent = getSelectedContent();  /* 2. Definir todo el c√≥digo de la aplicaci√≥n que correr√° dentro del Blob */  const appCode = function () % 7B    /* === L√ìGICA CORE (Copiada y adaptada) === */    const LanguageDetector = % 7B      spanishPatterns: % 7B        articles: /\b(el%7Cla%7Clos%7Clas%7Cun%7Cuna%7Cunos%7Cunas)\b/gi, conjunctions: /\b(y%7Ce%7Co%7Cu%7Cpero%7Csino%7Cporque%7Cque%7Csi)\b/gi, prepositions: /\b(de%7Cdel%7Ca%7Cal%7Cen%7Cpor%7Cpara%7Ccon%7Csin%7Csobre)\b/gi, pronouns: /\b(yo%7Ct√∫%7C√©l%7Cella%7Cnosotros%7Cvosotros%7Cellos%7Cellas%7Cme%7Cte%7Cse%7Cnos%7Cos)\b/gi, accents: /[√°√©√≠√≥√∫√±¬ø¬°]/g, commonWords: /\b(est√°%7Cson%7Cser%7Cestar%7Ctiene%7Chace%7Cmuy%7Cm√°s%7Ctambi√©n%7Ctodo%7Ccuando%7Chay)\b/gi % 7D, englishPatterns: % 7B        articles: /\b(the%7Ca%7Can)\b/gi, conjunctions: /\b(and%7Cor%7Cbut%7Cbecause%7Cif%7Cso)\b/gi, prepositions: /\b(in%7Con%7Cat%7Cto%7Cfor%7Cwith%7Cby%7Cfrom%7Cof)\b/gi, pronouns: /\b(i%7Cyou%7Che%7Cshe%7Cit%7Cwe%7Cthey%7Cme%7Chim%7Cher%7Cus%7Cthem)\b/gi, auxiliaries: /\b(is%7Care%7Cwas%7Cwere%7Chave%7Chas%7Chad%7Cdo%7Cdoes%7Cdid)\b/gi, commonWords: /\b(this%7Cthat%7Cthese%7Cthose%7Cthere%7Chere%7Cwhat%7Cwhen%7Cwhere%7Cwho%7Cwhich)\b/gi % 7D, calculateLanguageScore: function (text, patterns) % 7B        let score = 0; for (const category in patterns) % 7B          const matches = text.match(patterns[category]) % 7C% 7C[]; score += matches.length;        % 7D        return score;      % 7D, detectTechnicalTerms: function (text) % 7B        const technicalPatterns = /\b(software%7Chardware%7Cweb%7Conline%7Cinternet%7Cemail%7Csmartphone%7Ccomputer%7Capp%7Cwebsite%7Ccloud%7Cserver%7Cdatabase%7Capi%7Cframework%7Cfrontend%7Cbackend%7Cbrowser%7Ccookie%7Ccache%7Cdebug%7Cinterface%7Cnetwork%7Cplugin%7Cscript%7Cupdate)\b/gi; const matches = text.match(technicalPatterns) % 7C% 7C[]; return matches.length;      % 7D, analyzeLanguageDistribution: function (text) % 7B        const spanishScore = this.calculateLanguageScore(text, this.spanishPatterns); const englishScore = this.calculateLanguageScore(text, this.englishPatterns); const technicalTerms = this.detectTechnicalTerms(text); const adjustedEnglishScore = englishScore - (technicalTerms * 0.75); const total = spanishScore + adjustedEnglishScore; const spanishPercentage = total > 0 ? (spanishScore / total) * 100 : 50; return { mainLanguage: spanishScore > adjustedEnglishScore ? % 27es% 27 : %27en % 27, spanishPercentage: spanishPercentage.toFixed(1), technicalTerms: technicalTerms, isHybrid: spanishPercentage > 15 && spanishPercentage < 85        };      }, generateLanguageReport: function (text) { const analysis = this.analyzeLanguageDistribution(text); let message = % 27 % 27; if (analysis.isHybrid) { message = `Texto mixto (${analysis.spanishPercentage}% espa√±ol) con ${analysis.technicalTerms} t√©rminos t√©cnicos. `; message += % 27Aplicando an√°lisis de legibilidad para el idioma predominante.% 27; } else { message = analysis.mainLanguage == % 27es % 27 ? `Texto principalmente en espa√±ol (${analysis.spanishPercentage}%) con terminolog√≠a t√©cnica.` : `Texto principalmente en ingl√©s con algunos t√©rminos en espa√±ol.`; } return { languageInfo: message, detectedLanguage: analysis.mainLanguage, isHybrid: analysis.isHybrid }; }    }; const ReadabilityAnalyzer = { countSyllables: function (word, lang) { word = word.toLowerCase(); if (lang === % 27es % 27) { word = word.replace(/[√°√©√≠√≥√∫]/g, % 27a % 27).replace(/[√º√Ø]/g, % 27i % 27).replace(/[^a-z]/g, % 27 % 27); const diphthongs = /(ai|au|ei|eu|io|ou|oi|ui|iu|ie|ue|ua)/g; const triphthongs = /(uai|iai|uei|ioi)/g; const vowelGroups = word.match(/[aeiou]+/g) || []; let count = vowelGroups.length; const diphthongCount = (word.match(diphthongs) || []).length; const triphthongCount = (word.match(triphthongs) || []).length; count = count - diphthongCount - (triphthongCount * 2); return Math.max(count, 1); } else { word = word.replace(/(?:[^laeiouy]es|ed|[^laeiouy]e)$/, % 27 % 27).replace(/^y/, % 27 % 27); return(word.match(/[aeiouy]{1,2}/g) || []).length || 1; } }, calculateSpanishIndex: function (syllables, words, sentences) { return 206.835 - (62.3 * (syllables / words)) - (words / sentences);      }, calculateEnglishIndex: function (syllables, words, sentences) { return 206.835 - (1.015 * (words / sentences)) - (84.6 * (syllables / words)); }, interpretScore: function (score, lang) { if (lang === % 27es % 27) { if (score <= 40) return "Muy dif√≠cil (Nivel universitario o cient√≠fico)"; if (score <= 55) return "Algo dif√≠cil (Bachillerato, divulgaci√≥n cient√≠fica)"; if (score <= 65) return "Normal (ESO, prensa general)"; if (score <= 80) return "Bastante f√°cil (Educaci√≥n primaria, prensa deportiva)"; return "Muy f√°cil (Educaci√≥n primaria, comics)"; } else { if (score >= 90) return "Very easy (5th grade)"; if (score >= 80) return "Easy (6th grade)"; if (score >= 70) return "Fairly easy (7th grade)"; if (score >= 60) return "Standard (8th-9th grade)"; if (score >= 50) return "Fairly difficult (10th-12th grade)"; if (score >= 30) return "Difficult (College)"; return "Very difficult (College graduate)"; } }, analyzeText: function (text) { if (!text || text.trim() === % 27 % 27) { return { language: % 27es% 27, syllables: 0, words: 0, sentences: 0, syllablesPerWord: "0", wordsPerSentence: "0", readabilityScore: "0", interpretation: "Sin texto para analizar", languageInfo: "", isHybrid: false }; } const languageInfo = LanguageDetector.generateLanguageReport(text); const lang = languageInfo.detectedLanguage; const cleanText = text.replace(/\s+/g, % 27 % 27).trim(); const words = cleanText.split(/\s+/).filter(w => w.length > 0);        /* Uso de l√≥gica de oraciones igual a triggerSave */        let sentences = 0; if (typeof Intl !== % 27undefined % 27 && Intl.Segmenter) { try { const segmenter = new Intl.Segmenter(undefined, { granularity: % 27sentence% 27 }); sentences = Array.from(segmenter.segment(text)).filter(s => /[a-zA-Z√°√©√≠√≥√∫√º√±√Å√â√ç√ì√ö√ú√ë]/.test(s.segment)).length; } catch (e) { sentences = 0; }        }        if (sentences === 0) { sentences = cleanText.split(/[.!?]+/).filter(s => s.trim().length > 0).length; } if (words.length === 0 || sentences === 0) { return { language: lang, syllables: 0, words: 0, sentences: 0, syllablesPerWord: "0", wordsPerSentence: "0", readabilityScore: "0", interpretation: "Texto muy corto", languageInfo: languageInfo.languageInfo, isHybrid: languageInfo.isHybrid }; } const syllables = words.reduce((acc, word) => acc + this.countSyllables(word, lang), 0); const score = lang === % 27es% 27 ? this.calculateSpanishIndex(syllables, words.length, sentences) : this.calculateEnglishIndex(syllables, words.length, sentences); return { language: lang, syllables, words: words.length, sentences: sentences, syllablesPerWord: (syllables / words.length).toFixed(2), wordsPerSentence: (words.length / sentences).toFixed(2), readabilityScore: score.toFixed(2), interpretation: this.interpretScore(score, lang), languageInfo: languageInfo.languageInfo, isHybrid: languageInfo.isHybrid };      }    }; const MarkdownConverter = { convert: function (markdown) { if (!markdown) return % 27 % 27; let html = markdown; const codeBlocks = []; html = html.replace(/```([\s\S]*?)```/g, function (match, code) { codeBlocks.push(`<pre><code>${code.replace(/</g, % 27 & lt;% 27).replace(/>/g, % 27 & gt;% 27) }</code></pre> `);          return ` %% CODEBLOCK${ codeBlocks.length - 1 }%% `;        });        const inlineCodes = [];        html = html.replace(/`([^ `\n]+)` / g, function (match, code) { inlineCodes.push(`<code>${code.replace(/</g, % 27 & lt;% 27).replace(/>/g, % 27 & gt;% 27)}</code > `);          return ` %% INLINECODE${ inlineCodes.length - 1 }%% `;        });        let lines = html.split(%27\n%27);        let processedLines = [];        let inList = false;        let listType = %27%27;        let listItems = [];        for (let i = 0; i < lines.length; i++) {          let line = lines[i];          let processed = false;          if (/^### /.test(line)) { if (inList) { processedLines.push(this.closeList(listItems, listType)); inList = false; listItems = []; } processedLines.push(line.replace(/^### (.+)$/, '<h3>$1</h3>')); processed = true; }          else if (/^## /.test(line)) { if (inList) { processedLines.push(this.closeList(listItems, listType)); inList = false; listItems = []; } processedLines.push(line.replace(/^## (.+)$/, '<h2>$1</h2>')); processed = true; }          else if (/^# /.test(line)) { if (inList) { processedLines.push(this.closeList(listItems, listType)); inList = false; listItems = []; } processedLines.push(line.replace(/^# (.+)$/, '<h1>$1</h1>')); processed = true; }          else if (/^---+$/.test(line.trim())) { if (inList) { processedLines.push(this.closeList(listItems, listType)); inList = false; listItems = []; } processedLines.push('<hr>'); processed = true; }          else if (/^> /.test(line)) { if (inList) { processedLines.push(this.closeList(listItems, listType)); inList = false; listItems = []; } processedLines.push(line.replace(/^> (.+)$/, '<blockquote>$1</blockquote>')); processed = true; }          else if (/^[\*\-\+] /.test(line)) { let item = line.replace(/^[\*\-\+] (.+)$/, '$1'); if (!inList || listType !== 'ul') { if (inList) processedLines.push(this.closeList(listItems, listType)); inList = true; listType = 'ul'; listItems = []; } listItems.push(item); processed = true; }          else if (/^\d+\. /.test(line)) { let item = line.replace(/^\d+\. (.+)$/, '$1'); if (!inList || listType !== 'ol') { if (inList) processedLines.push(this.closeList(listItems, listType)); inList = true; listType = 'ol'; listItems = []; } listItems.push(item); processed = true; }          else if (inList && line.trim() !== '') { processedLines.push(this.closeList(listItems, listType)); inList = false; listItems = []; }          if (!processed) { if (!inList) processedLines.push(line); }        }        if (inList) processedLines.push(this.closeList(listItems, listType));        html = processedLines.join('\n');        html = html.replace(/\*\*\*([^\*]+)\*\*\*/g, '<b><i>$1</i></b>');        html = html.replace(/\*\*([^\*]+)\*\*/g, '<b>$1</b>');        html = html.replace(/__([^_]+)__/g, '<b>$1</b>');        html = html.replace(/(?<!\*)\*([^\*\n]+)\*(?!\*)/g, '<i>$1</i>');        html = html.replace(/(?<!_)_([^_\n]+)_(?!_)/g, '<i>$1</i>');        html = html.replace(/~~([^~]+)~~/g, '<del>$1</del>');        html = html.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img alt="$1" src="$2" style="max-width:100%">');        html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');        html = html.replace(/%%CODEBLOCK(\d+)%%/g, (match, index) => codeBlocks[parseInt(index)]);        html = html.replace(/%%INLINECODE(\d+)%%/g, (match, index) => inlineCodes[parseInt(index)]);        html = html.replace(/\n(?!<\/?(h[1-6]|p|div|blockquote|pre|ul|ol|li|hr))/g, '<br>\n');        html = html.replace(/(<br>\n){3,}/g, '<br>\n<br>\n');        return html;      },      closeList: function (items, type) {        if (items.length === 0) return '';        let listHtml = %60<${type}>%60;        items.forEach(item => {          item = item.replace(/\*\*\*([^\*]+)\*\*\*/g, '<b><i>$1</i></b>');          item = item.replace(/\*\*([^\*]+)\*\*/g, '<b>$1</b>');          item = item.replace(/(?<!\*)\*([^\*]+)\*(?!\*)/g, '<i>$1</i>');          item = item.replace(/~~([^~]+)~~/g, '<del>$1</del>');          item = item.replace(/%60([^%60]+)%60/g, '<code>$1</code>');          listHtml += %60<li>${item}</li>%60;        });        listHtml += %60</${type}>%60;        return listHtml;      },      detectAndConvert: function (text) {        if (!text) return '';        const hasMarkdown = /^#{1,3} /m.test(text) || /\*\*[^\*]+\*\*/g.test(text) || /\*[^\*\n]+\*/g.test(text) || /~~[^~]+~~/g.test(text) || /\[.+?\]\(.+?\)/.test(text) || /^> /m.test(text) || /^[\*\-\+] /m.test(text) || /^\d+\. /m.test(text) || /%60%60%60[\s\S]*?%60%60%60/.test(text) || /%60[^%60]+%60/.test(text) || /^---+$/m.test(text);        if (hasMarkdown) return this.convert(text);        return text;      }    };    const createDebouncer = function (originalFunction, waitTime) {      let timer;      return function (...args) {        clearTimeout(timer);        timer = setTimeout(() => originalFunction.apply(this, args), waitTime);      };    };    const safeSetHTML = (element, html) => {      try {        if (window.trustedTypes && window.trustedTypes.createPolicy) {          const policy = window.trustedTypes.createPolicy('bookmarklet-policy-' + Math.random(), {            createHTML: (input) => input          });          element.innerHTML = policy.createHTML(html);        } else {          element.innerHTML = html;        }      } catch (e) {        try { element.innerHTML = html; } catch (err) { console.error('HTML set failed', err); }      }    };    /* Helpers */    const formatDate = (date) => {      const pad = (num) => String(num).padStart(2, '0');      const d = new Date(date);      return %60${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}%60;    };    const countSentences = (text) => {      if (typeof Intl !== 'undefined' && Intl.Segmenter) {        try {          const segmenter = new Intl.Segmenter(undefined, { granularity: 'sentence' });          return Array.from(segmenter.segment(text)).filter(s => /[a-zA-Z√°√©√≠√≥√∫√º√±√Å√â√ç√ì√ö√ú√ë]/.test(s.segment)).length;        } catch (e) { }      }      return text.split(/[.!?¬°¬ø]+/).filter(sentence => sentence.trim().length > 1).length;    };    const calculateAverageWordsPerSentence = (wordCount, sentenceCount) => {      if (wordCount === 0 || sentenceCount === 0) return "0";      return (wordCount / sentenceCount).toFixed(1);    };    const countParagraphs = text => {      const paragraphs = text.split(/\n{2,}|(<\/p>|<br\s*\/?>\s*<br\s*\/?>)/g).filter(p => p && p.trim().length > 1);      return paragraphs.length || (text.trim() ? 1 : 0);    };    const interpretMetrics = (metrics) => {      if (metrics.wordCount === 0) return "Esperando texto...";      let interpretation = "";      if (metrics.wordCount < 100) interpretation += "Texto corto. ";      else if (metrics.wordCount < 500) interpretation += "Texto de longitud media. ";      else interpretation += "Texto largo. ";      if (metrics.avgWordsPerSentence < 10) interpretation += "Oraciones muy cortas, f√°cil de leer. ";      else if (metrics.avgWordsPerSentence < 20) interpretation += "Oraciones de longitud moderada. ";      else interpretation += "Oraciones largas. ";      return interpretation;    };    const showNotification = function (message, type = 'success') {      const notification = document.createElement('div');      notification.textContent = message;      notification.className = %60notification ${type}%60;      document.body.appendChild(notification);      setTimeout(() => notification.remove(), 3000);    };    const showActionFeedback = function (message, type = 'success') {      const feedbackEl = document.getElementById('actionFeedback');      if (feedbackEl) {        feedbackEl.textContent = message;        feedbackEl.style.color = type === 'error' ? '#f44336' : '#4CAF50';        feedbackEl.classList.add('visible');        setTimeout(() => feedbackEl.classList.remove('visible'), 4000);      }    };    const updateStats = function () {      try {        const notepad = document.getElementById('notepad');        const text = notepad.innerText || notepad.textContent || '';        const words = text.trim().split(/\s+/).filter(word => word.length > 0);        const wordCount = words.length;        const charCount = text.replace(/\s+/g, '').length;        const sentenceCount = countSentences(text);        const avgWordsPerSentence = calculateAverageWordsPerSentence(wordCount, sentenceCount);        const paragraphCount = countParagraphs(text);        const wordsPerMinute = 250;        const readTimeSeconds = Math.round((wordCount / wordsPerMinute) * 60);        const minutes = Math.floor(readTimeSeconds / 60);        const seconds = readTimeSeconds % 60;        let readabilityResults = ReadabilityAnalyzer.analyzeText(text);        document.getElementById('wordCount').textContent = wordCount;        document.getElementById('charCount').textContent = charCount;        document.getElementById('sentenceCount').textContent = sentenceCount;        document.getElementById('avgWordsPerSentence').textContent = avgWordsPerSentence;        document.getElementById('paragraphCount').textContent = paragraphCount;        document.getElementById('readTime').textContent = %60${minutes} min ${seconds} seg%60;        if (text.trim() === '') {          document.getElementById('interpretation').innerHTML = "<b>Resumen:</b> Esperando texto...";        } else {          const metrics = interpretMetrics({ wordCount, charCount, sentenceCount, avgWordsPerSentence, paragraphCount });          document.getElementById('interpretation').innerHTML = %60<b>Resumen:</b> ${metrics} Legibilidad: ${readabilityResults.interpretation} (Puntuaci√≥n: ${readabilityResults.readabilityScore})%60;        }      } catch (error) { console.error('Error stats:', error); }    };    const triggerSave = function () {      const defaultFileName = %60NOTAS_${formatDate(new Date())}.html%60;      const fileName = prompt('Introduce el nombre del archivo:', defaultFileName);      if (fileName === null) { showActionFeedback('Guardado cancelado', 'error'); return; }      const finalFileName = fileName || defaultFileName;      const blob = new Blob([document.getElementById('notepad').innerHTML], { type: 'text/html' });      const a = document.createElement('a');      a.href = URL.createObjectURL(blob);      a.download = finalFileName;      a.style.display = 'none';      document.body.appendChild(a);      a.click();      document.body.removeChild(a);      showActionFeedback(%60Archivo guardado como '${finalFileName}'%60);    };    const triggerSaveMarkdown = function () {      const defaultFileName = %60NOTA_${formatDate(new Date())}.md%60;      const fileName = prompt('Guardar como Markdown:', defaultFileName);      if (fileName === null) return;      const noteContent = document.getElementById('notepad').innerText || '';      const blob = new Blob([noteContent], { type: 'text/markdown' });      const a = document.createElement('a');      a.href = URL.createObjectURL(blob);      a.download = fileName || defaultFileName;      a.style.display = 'none';      document.body.appendChild(a);      a.click();      document.body.removeChild(a);      showActionFeedback('Guardado como Markdown');    };    /* Botones y Eventos */    const copyPlainText = function () {      const text = document.getElementById('notepad').innerText;      navigator.clipboard.writeText(text).then(() => showNotification('Texto plano copiado'))        .catch(() => showNotification('Error al copiar', 'error'));    };    const copyRichText = function () {      const notepad = document.getElementById('notepad');      const htmlContent = notepad.innerHTML;      const textContent = notepad.innerText;      const clipboardData = [new ClipboardItem({ 'text/html': new Blob([htmlContent], { type: 'text/html' }), 'text/plain': new Blob([textContent], { type: 'text/plain' }) })];      navigator.clipboard.write(clipboardData).then(() => showNotification('Texto enriquecido copiado')).catch(() => showNotification('Error al copiar', 'error'));    };    const convertMarkdownAndCopy = function () {      const notepad = document.getElementById('notepad');      const currentText = notepad.innerText;      const html = MarkdownConverter.convert(currentText);      saveToHistory();      safeSetHTML(notepad, html);      updateStats();      const clipboardData = [new ClipboardItem({ 'text/html': new Blob([html], { type: 'text/html' }), 'text/plain': new Blob([currentText], { type: 'text/plain' }) })];      navigator.clipboard.write(clipboardData).then(() => showNotification('Convertido y Copiado')).catch(() => showNotification('Convertido'));    };    let undoHistory = [];    let redoHistory = [];    const saveToHistory = function () {      const notepad = document.getElementById('notepad');      undoHistory.push(notepad.innerHTML);      if (undoHistory.length > 50) undoHistory.shift();      redoHistory = [];    };    const undo = function () {      if (undoHistory.length > 0) {        redoHistory.push(document.getElementById('notepad').innerHTML);        safeSetHTML(document.getElementById('notepad'), undoHistory.pop());        updateStats();        showActionFeedback('Cambio deshecho');      }    };    const clearText = function () {      saveToHistory();      safeSetHTML(document.getElementById('notepad'), '');      updateStats();      showActionFeedback('Limpiado');    };    /* INICIALIZACI√ìN */    const notepad = document.getElementById('notepad');    if (window.INITIAL_CONTENT) {      const tempDiv = document.createElement('div');      tempDiv.innerHTML = window.INITIAL_CONTENT;      const textContent = tempDiv.innerText || '';      /* Detecci√≥n inicial de Markdown vs HTML */      if (!/<[^>]+>/.test(window.INITIAL_CONTENT) || window.INITIAL_CONTENT === textContent) {        const converted = MarkdownConverter.detectAndConvert(textContent);        safeSetHTML(notepad, converted);        if (converted !== textContent) showNotification('Markdown convertido');      } else {        safeSetHTML(notepad, window.INITIAL_CONTENT);        showNotification('HTML cargado');      }    }    /* Listeners b√°sicos */    const debouncedUpdate = createDebouncer(updateStats, 300);    notepad.addEventListener('input', () => { saveToHistory(); debouncedUpdate(); });    notepad.addEventListener('paste', (e) => {      saveToHistory();      /* L√≥gica de pegado simple por ahora */      setTimeout(() => {        /* Check si lo pegado parece markdown */        const text = notepad.innerText;        const converted = MarkdownConverter.detectAndConvert(text);        debouncedUpdate();      }, 100);    });    document.addEventListener('keydown', (e) => { if (e.ctrlKey && e.key === 's') { e.preventDefault(); triggerSave(); } });    document.getElementById('saveButton').addEventListener('click', triggerSave);    document.getElementById('saveMarkdownButton').addEventListener('click', triggerSaveMarkdown);    document.getElementById('copyPlainButton').addEventListener('click', copyPlainText);    document.getElementById('copyRichButton').addEventListener('click', copyRichText);    document.getElementById('convertMarkdownButton').addEventListener('click', convertMarkdownAndCopy);    document.getElementById('undoButton').addEventListener('click', undo);    document.getElementById('clearButton').addEventListener('click', clearText);    document.getElementById('toggleInstructions').addEventListener('click', function () {      document.getElementById('instructions').classList.toggle('hidden');    });    /* Theme */    const toggleThemeBtn = document.getElementById('toggleTheme');    toggleThemeBtn.addEventListener('click', () => {      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';      document.documentElement.setAttribute('data-theme', isDark ? 'light' : 'dark');    });    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {      document.documentElement.setAttribute('data-theme', 'dark');    }    updateStats();    notepad.focus();  };  /* 3. Definir estilos CSS */  const styles = %60    :root { --bg-color:#f0f0f0; --text-color:#333; --header-bg:rgba(250,250,250,.95); --header-border:#e0e0e0; --notepad-bg:#fff; --notepad-text:#000; --panel-bg:rgba(250,250,250,.97); --panel-text:#333; --stat-bg:#fff; --stat-text:#666; --stat-value:#2196F3; }    [data-theme="dark"] { --bg-color:#1a1a1a; --text-color:#e0e0e0; --header-bg:rgba(30,30,30,.95); --header-border:#444; --notepad-bg:#2d2d2d; --notepad-text:#e0e0e0; --panel-bg:rgba(30,30,30,.97); --panel-text:#e0e0e0; --stat-bg:#383838; --stat-text:#aaa; --stat-value:#64b5f6; }    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;font-size:1.3rem;margin:0;padding:50px 1rem 1rem;background-color:var(--bg-color);color:var(--text-color);min-height:100vh;box-sizing:border-box;transition:background-color .3s,color .3s}    #header{position:fixed;top:0;left:0;right:0;display:flex;justify-content:space-between;align-items:center;padding:8px 15px;background-color:var(--header-bg);backdrop-filter:blur(5px);border-bottom:1px solid var(--header-border);z-index:1001;transition:background-color .3s,border-color .3s}    #branding-title{font-size:1rem;font-weight:600;color:var(--panel-text)}    #header-hints{display:flex;align-items:center;gap:15px;font-size:.8rem;color:var(--stat-text)}    button{cursor:pointer}    #saveButton{padding:.3rem .7rem;font-size:.8rem;color:#fff;border:none;border-radius:5px;background-color:#007bff;transition:all .2s ease}    #saveButton:hover{background-color:#0056b3}    #toggleTheme{padding:.3rem .7rem;font-size:.8rem;background:transparent;border:1px solid var(--stat-text);color:var(--stat-text);border-radius:5px;transition:all .2s ease}    #toggleInstructions{padding:5px 10px;background:#6c757d;color:#fff;border:none;border-radius:5px;box-shadow:0 1px 2px rgba(0,0,0,.1)}    #instructions{background-color:var(--header-border);color:var(--text-color);padding:.7rem;margin-bottom:1.5rem;border-radius:5px;font-size:1rem;position:relative;z-index:100;max-height:2000px;overflow-y:auto;opacity:1;transition:all .3s ease-out}    #instructions.hidden{max-height:0;opacity:0;margin:0;padding:0;overflow:hidden}    #notepad{background-color:var(--notepad-bg);color:var(--notepad-text);min-height:300px;padding:.5rem;border:1px solid #ccc;border-radius:5px;width:95%;margin:1rem auto 120px;font-size:1.2rem;resize:vertical;overflow:auto;line-height:1.6;text-align:justify;hyphens:auto;word-wrap:break-word}    #notepad blockquote{border-left:3px solid #ccc;margin-left:0;padding-left:1rem;color:#666}    #notepad code{background:#f4f4f4;padding:2px 4px;border-radius:3px;font-family:monospace;color:#333}    #fixedPanel{position:fixed;bottom:0;left:0;right:0;background-color:var(--panel-bg);color:var(--panel-text);box-shadow:0 -2px 10px rgba(0,0,0,.1);border-top:1px solid var(--header-border);z-index:1000;padding:.3rem;transition:transform .3s ease,max-height .3s ease,background-color .3s;max-height:30vh;overflow-y:auto}    #fixedPanel.minimized{transform:translateY(calc(100% - 38px))}    #statsContainer{max-height:0;overflow:hidden;opacity:0;transition:all .3s ease}    #fixedPanel:hover #statsContainer{max-height:500px;opacity:1;padding:8px;margin-bottom:8px;background-color:var(--bg-color);border-radius:4px}    .stats-row{display:flex;justify-content:space-between;align-items:stretch;gap:8px;margin-bottom:8px}    .statItem{flex:1;text-align:center;background-color:var(--stat-bg);color:var(--stat-text);padding:8px 4px;border-radius:4px;display:flex;flex-direction:column;justify-content:space-between;box-shadow:0 1px 3px rgba(0,0,0,.1)}    .statValue{font-size:1rem;color:var(--stat-value);font-weight:500}    #interpretation{width:100%;text-align:center;padding:8px;background-color:var(--stat-bg);color:var(--stat-text);border-radius:4px;margin-top:8px;font-size:.9rem;box-shadow:0 1px 3px rgba(0,0,0,.1)}    #buttonContainer{display:flex;justify-content:center;gap:.5rem;padding:4px 0}    .copyButton{padding:.4rem .8rem;font-size:.9rem;color:#fff;border:none;border-radius:5px;background-color:#4CAF50;box-shadow:0 2px 4px rgba(0,0,0,.2)}    #copyPlainButton{background-color:#4CAF50} #copyRichButton{background-color:#2196F3} #undoButton{background-color:#607D8B} #clearButton{background-color:#F44336} #convertMarkdownButton{background-color:#9C27B0} #saveMarkdownButton{background-color:#ff9800}    .notification{position:fixed;top:60px;left:50%;transform:translateX(-50%);padding:10px 20px;border-radius:5px;color:#fff;font-size:.9rem;z-index:10002;background-color:#333;animation:fadeIn .3s ease}    #actionFeedback{font-size:.8rem;text-align:center;color:var(--text-color);height:0;opacity:0;transition:all .3s}    #actionFeedback.visible{height:auto;opacity:1;padding:4px 0}  %60;  /* 4. Construir el HTML final */  const htmlContent = %60    <!DOCTYPE html>    <html lang="es">    <head>        <meta charset="UTF-8">        <title>Notas.IA Editor</title>        <style>${styles}</style>    </head>    <body>        <div id="header">            <div id="branding-title">Smart Editor Pro <sup>v3.1</sup></div>            <div id="header-hints">                <span>üíæ Ctrl+S</span>                <button id="toggleTheme" title="Cambiar tema">üåó</button>                <button id="saveButton">Guardar HTML</button>                <button id="toggleInstructions">Instrucciones</button>            </div>        </div>        <div id="instructions" class="hidden">            <h3>üìù Gu√≠a R√°pida de Uso</h3>            <p>Bienvenido a Smart Editor Pro. Has capturado el contenido seleccionado de la web.</p>            <ul>                <li>‚úç%EF%B8%8F <b>Edita:</b> Modifica el texto libremente. El an√°lisis se actualiza solo.</li>                <li>üìä <b>Analiza:</b> Revisa la legibilidad y estad√≠sticas en el panel inferior.</li>                <li>üíæ <b>Exporta:</b> Guarda tu trabajo como archivo HTML o Markdown.</li>                <li>üåì <b>Tema:</b> Alterna entre modo claro y oscuro seg√∫n tu preferencia.</li>            </ul>            <p style="font-size:0.9em; margin-top:10px"><i>Truco: Pulsa <b>Ctrl+S</b> para guardar r√°pidamente tu nota.</i></p>        </div>        <div id="notepad" contenteditable="true" spellcheck="true"></div>        <div id="fixedPanel">            <div id="statsContainer">                <div class="stats-row">                    <div class="statItem"><div>Palabras</div><div id="wordCount" class="statValue">0</div></div>                    <div class="statItem"><div>Caracteres</div><div id="charCount" class="statValue">0</div></div>                    <div class="statItem"><div>Frases</div><div id="sentenceCount" class="statValue">0</div></div>                    <div class="statItem"><div>Pal/Frase</div><div id="avgWordsPerSentence" class="statValue">0</div></div>                    <div class="statItem"><div>P√°rrafos</div><div id="paragraphCount" class="statValue">0</div></div>                    <div class="statItem"><div>Tiempo</div><div id="readTime" class="statValue">0 min</div></div>                </div>                <div id="interpretation"></div>            </div>            <div id="actionFeedback"></div>            <div id="buttonContainer">                <button id="copyPlainButton" class="copyButton">Copiar Texto</button>                <button id="copyRichButton" class="copyButton" style="background-color:#2196F3">Copiar Rico</button>                <button id="convertMarkdownButton" class="copyButton" style="background-color:#9C27B0">MD ‚Üí HTML</button>                <button id="saveMarkdownButton" class="copyButton" style="background-color:#ff9800">Guardar .md</button>                <button id="undoButton" class="copyButton" style="background-color:#607D8B">Deshacer</button>                <button id="clearButton" class="copyButton" style="background-color:#F44336">Limpiar</button>            </div>            <div style="font-size:0.7rem;text-align:center;color:var(--stat-text);margin-top:5px">                Panel minimizable al hacer click fuera de los botones            </div>        </div>        <script>            window.INITIAL_CONTENT = ${JSON.stringify(initialContent)};            (${appCode.toString()})();        <\/script>    </body>    </html>  %60;  /* 5. Crear Blob y abrir ventana */  try {    const blob = new Blob([htmlContent], { type: 'text/html' });    const url = URL.createObjectURL(blob);    const win = window.open(url, '_blank', 'width=950,height=800,toolbar=no,menubar=no,location=no,status=no');    if (!win) {      alert('Por favor, permite las ventanas emergentes (pop-ups) para usar el editor.');    }  } catch (e) {    console.error("Error iniciando Smart Editor:", e);    alert("Error iniciando el editor: " + e.message);  }})();